# .github/workflows/.codeql.yml
name: "CodeQL ESM TypeScript Scans"

on:
  push:
    branches: main
    paths:
      - 'backend/src/**'
      - 'frontend/src/**'
      - '.github/workflows/.codeql.yml'
  pull_request:
    branches: main
    paths:
      - 'backend/src/**'
      - 'frontend/src/**'
      - '.github/workflows/.codeql.yml'

jobs:
  backend-codeql:
    name: "CodeQL Scan: Backend (NodeJS ESM TS)"
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: "Checkout repository"
        uses: actions/checkout@v4

      - name: "Initialize CodeQL"
        uses: github/codeql-action/init@v2
        with:
          languages: javascript,typescript

      - name: "Setup Node.js 18.x"
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
          cache: 'npm'

      - name: "Install dependencies"
        run: npm ci

      - name: "Build Backend"
        run: npm run build:backend
        # ↳ Assumes you have a "build:backend" script in package.json that compiles your backend TS (e.g. "tsc -p tsconfig.backend.json").

      - name: "Perform Backend CodeQL Analysis"
        uses: github/codeql-action/analyze@v2
        with:
          category: "codeql-backend-scan"
          extra-options: |
            --include='backend/src/**/*.ts'
            # Exclude everything else by not listing other paths.

  # frontend-codeql:
  #   name: "CodeQL Scan: Frontend (Web ESM TS)"
  #   needs: backend-codeql
  #   runs-on: ubuntu-latest
  #   permissions:
  #     contents: read
  #     security-events: write

  #   steps:
  #     - name: "Checkout repository"
  #       uses: actions/checkout@v4

  #     - name: "Initialize CodeQL"
  #       uses: github/codeql-action/init@v2
  #       with:
  #         languages: javascript,typescript

  #     - name: "Setup Node.js 18.x"
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: 18.x
  #         cache: 'npm'

  #     - name: "Install Frontend Dependencies"
  #       run: |
  #         cd web
  #         npm ci
  #       # ↳ Assumes your web/ folder has its own package.json.

  #     - name: "Build Frontend"
  #       run: |
  #         cd web
  #         npm run build
  #       # ↳ Assumes you have a "build" script in web/package.json to produce the ESM bundle(s).

  #     - name: "Perform Frontend CodeQL Analysis"
  #       uses: github/codeql-action/analyze@v2
  #       with:
  #         category: "codeql-frontend-scan"
  #         extra-options: |
  #           --include='web/**/*.ts'
  #           --include='web/**/*.js'

